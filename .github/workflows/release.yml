name: Master Release Workflow

on:
  push:
    branches: [ main, master ]
  release:
    types: [ published ]

jobs:
  # Logic to determine if we use the Release Tag or the Commit ID as the produced build number
  setup:
    runs-on: ubuntu-latest
    outputs:
      version_id: ${{ steps.vars.outputs.version_id }}
      today: ${{ steps.vars.outputs.today }}
    steps:
      - name: Set Variables
        id: vars
        env:
          GITHUB_SHA: ${{ github.sha }}
        run: |
          # Get Today's Date
          echo "today=$(date +'%Y.%m.%d')" >> $GITHUB_OUTPUT
          
          # Check if this is a release or a push
          if [[ "${{ github.event_name }}" == "release" ]]; then
            echo "version_id=${{ github.event.release.tag_name }}" >> $GITHUB_OUTPUT
          else
            # A continuous build. Use the commit id. Example: version_id=continuous-3e51852
            echo "version_id=continuous-${GITHUB_SHA::7}" >> $GITHUB_OUTPUT
          fi

  # Call the Child Workflows
  build-linux:
    needs: setup
    uses: ./.github/workflows/build-linux.yml
    with:
      version_id: ${{ needs.setup.outputs.version_id }}
      today: ${{ needs.setup.outputs.today }}

  # Final job to collect artifacts and post to the release page
  publish:
    needs: [setup, build-linux]
    runs-on: ubuntu-latest
    if: github.event_name == 'release' || github.event_name == 'push'
    steps:
      - name: Download all artifacts
        uses: actions/download-artifact@v4
      
      - name: Upload to Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.event_name == 'push' && 'continuous' || github.event.release.tag_name }}
          name: ${{ github.event_name == 'push' && 'Continuous Build' || github.event.release.name }}
          prerelease: ${{ github.event_name == 'push' || github.event.release.prerelease == true }}
          files: |
            **/*.deb
            **/*.AppImage
            **/*.exe
            **/*.dmg
            **/*.zip
